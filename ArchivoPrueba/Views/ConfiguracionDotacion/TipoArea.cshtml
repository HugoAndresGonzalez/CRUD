@model ArchivoPrueba.ViewModels.ConfiguracionDotacion.ConfigDotacionTipoAreaVM

@{
    ViewBag.Title = "Dotación por Área";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h3>Configuración de Dotación por Área</h3>
<hr />

@if (TempData["Ok"] != null)
{
    <div class="alert alert-success">
        @TempData["Ok"]
    </div>
}

@using (Html.BeginForm("GuardarTipoArea", "ConfiguracionDotacion", FormMethod.Post))
{
    @Html.AntiForgeryToken()

    <!-- Selector Área -->
    <div class="row mb-3">
        <div class="col-md-6">
            <label class="form-label">Área</label>
            @Html.DropDownListFor(
                m => m.TipoAreaSeleccionada,
                Model.TiposArea,
                "-- Seleccione --",
                new
                {
                    @class = "form-select",
                    onchange = "onTipoAreaChange(this)"
                })
            @Html.ValidationMessageFor(m => m.TipoAreaSeleccionada, "", new { @class = "text-danger" })
        </div>
    </div>

    <!-- Agregar prenda -->
    <fieldset class="border p-3 mb-3">
        <legend class="w-auto px-2">Agregar prenda</legend>

        <div class="row align-items-end">
            <div class="col-md-5">
                <label class="form-label">Prenda</label>
                <select id="ddlPrenda" class="form-select">
                    <option value="">-- Seleccione --</option>
                    @foreach (var p in Model.PrendasDisponibles)
                    {
                        <option value="@p.Value">@p.Text</option>
                    }
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label">Cantidad</label>
                <input id="txtCantidad" type="number" class="form-control" min="1" value="1" />
            </div>

            <div class="col-md-4">
                <button type="button"
                        class="btn btn-outline-primary mt-2"
                        onclick="addRow()">
                    Agregar
                </button>
            </div>
        </div>
    </fieldset>

    @Html.ValidationSummary(false, "", new { @class = "text-danger" })

    <!-- Tabla de prendas -->
    <div class="table-responsive mb-3">
        <table class="table table-bordered table-sm" id="tblItems">
            <thead class="table-light">
                <tr>
                    <th>Prenda</th>
                    <th style="width: 150px;">Cantidad</th>
                    <th style="width: 120px;">Acción</th>
                </tr>
            </thead>
            <tbody>
                @for (int i = 0; i < (Model.Items != null ? Model.Items.Count : 0); i++)
                {
                    <tr>
                        <td>
                            @Html.HiddenFor(m => m.Items[i].PrendaId)
                            @Model.Items[i].PrendaNombre
                        </td>
                        <td>
                            @Html.TextBoxFor(
                                m => m.Items[i].Cantidad,
                                new { @class = "form-control", type = "number", min = "1" }
                            )
                        </td>
                        <td>
                            <button type="button"
                                    class="btn btn-sm btn-outline-danger"
                                    onclick="removeRow(this)">
                                Quitar
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Botones -->
    <div class="mt-3">
        <button type="submit" class="btn btn-primary">
            Guardar configuración
        </button>
        <a class="btn btn-secondary"
           href="@Url.Action("Index", "ConfiguracionDotacion")">
            Volver
        </a>
    </div>
}

@section scripts {
    <script>
    function onTipoAreaChange(select) {
        var val = select.value || "";
        var url = '@Url.Action("TipoArea", "ConfiguracionDotacion")';

        if (val.trim() === "") {
            window.location.href = url;
            return;
        }

        window.location.href = url + "?tipoArea=" + encodeURIComponent(val);
    }

    function addRow() {
        var ddl = document.getElementById("ddlPrenda");
        var qty = document.getElementById("txtCantidad");

        var prendaId = ddl.value;
        var prendaText = ddl.options[ddl.selectedIndex] ?
                         ddl.options[ddl.selectedIndex].text : "";
        var cantidad = parseInt(qty.value || "0");

        if (!prendaId) {
            alert("Seleccione una prenda.");
            return;
        }
        if (!cantidad || cantidad < 1) {
            alert("Cantidad inválida.");
            return;
        }

        // Evitar duplicados
        var existing = document.querySelectorAll("#tblItems tbody input[type='hidden']");
        for (var i = 0; i < existing.length; i++) {
            if (existing[i].value === prendaId) {
                alert("La prenda ya fue agregada.");
                return;
            }
        }

        var tbody = document.querySelector("#tblItems tbody");
        var index = tbody.querySelectorAll("tr").length;

        var tr = document.createElement("tr");
        tr.innerHTML =
            "<td>" +
                "<input type='hidden' name='Items[" + index + "].PrendaId' value='" + prendaId + "' />" +
                prendaText +
            "</td>" +
            "<td>" +
                "<input class='form-control' type='number' min='1' name='Items[" + index + "].Cantidad' value='" + cantidad + "' />" +
            "</td>" +
            "<td>" +
                "<button type='button' class='btn btn-sm btn-outline-danger' onclick='removeRow(this)'>Quitar</button>" +
            "</td>";

        tbody.appendChild(tr);

        ddl.value = "";
        qty.value = "1";
    }

    function removeRow(btn) {
        var row = btn.closest("tr");
        row.remove();
        reindex();
    }

    function reindex() {
        var rows = document.querySelectorAll("#tblItems tbody tr");

        for (var i = 0; i < rows.length; i++) {
            var hidden = rows[i].querySelector("input[type='hidden']");
            var number = rows[i].querySelector("input[type='number']");

            hidden.name = "Items[" + i + "].PrendaId";
            number.name = "Items[" + i + "].Cantidad";
        }
    }
    </script>
}